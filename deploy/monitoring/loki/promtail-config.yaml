# Promtail Configuration for MLSDM Log Collection
# =================================================
# Promtail collects logs and ships them to Loki.
# This configuration is optimized for MLSDM JSON structured logs.
#
# Documentation: https://grafana.com/docs/loki/latest/send-data/promtail/configuration/

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    tenant_id: mlsdm

scrape_configs:
  # ============================================
  # MLSDM Application Logs
  # ============================================
  - job_name: mlsdm-api
    static_configs:
      - targets:
          - localhost
        labels:
          job: mlsdm
          app: neuro-engine
          __path__: /var/log/mlsdm/*.log

    # JSON parsing for structured logs
    pipeline_stages:
      # Parse JSON log entries
      - json:
          expressions:
            level: level
            event_type: event_type
            correlation_id: correlation_id
            message: message
            trace_id: trace_id
            span_id: span_id
            error_code: 'metrics.error_code'
            request_id: 'metrics.request_id'
            latency_ms: 'metrics.latency_ms'
            accepted: 'metrics.accepted'
            phase: 'metrics.phase'

      # Add labels from parsed JSON
      - labels:
          level:
          event_type:
          error_code:
          phase:
          accepted:

      # Use timestamp from log entry
      - timestamp:
          source: timestamp
          format: RFC3339Nano

      # Extract metrics from logs
      - metrics:
          log_latency_ms:
            type: Histogram
            description: "Latency from log entries"
            source: latency_ms
            config:
              buckets: [10, 50, 100, 250, 500, 1000, 2500, 5000]

          log_requests_total:
            type: Counter
            description: "Total requests from logs"
            config:
              match_all: true
              action: inc

          log_errors_total:
            type: Counter
            description: "Errors from logs"
            source: level
            config:
              value: ERROR
              action: inc

  # ============================================
  # Kubernetes Pod Logs (if running in K8s)
  # ============================================
  - job_name: kubernetes-pods
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      # Only scrape pods with mlsdm label
      - source_labels: [__meta_kubernetes_pod_label_app]
        regex: mlsdm.*
        action: keep

      # Use pod name as instance label
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: instance

      # Use namespace as label
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace

      # Use pod labels
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)

    pipeline_stages:
      # Parse JSON
      - json:
          expressions:
            level: level
            event_type: event_type
            error_code: 'metrics.error_code'

      - labels:
          level:
          event_type:
          error_code:

  # ============================================
  # Docker Container Logs
  # ============================================
  - job_name: docker-containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      # Only scrape containers with mlsdm in name
      - source_labels: [__meta_docker_container_name]
        regex: '.*mlsdm.*'
        action: keep

      # Use container name as instance
      - source_labels: [__meta_docker_container_name]
        target_label: container

    pipeline_stages:
      - json:
          expressions:
            level: level
            event_type: event_type
            error_code: 'metrics.error_code'

      - labels:
          level:
          event_type:
          error_code:

# ============================================
# Target Labels (applied to all targets)
# ============================================
target_config:
  sync_period: 10s
