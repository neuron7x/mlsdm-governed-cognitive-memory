name: Chaos Engineering Tests

# REL-003: Run chaos tests on schedule (not on every PR)
on:
  schedule:
    # Run daily at 3:00 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      test_category:
        description: 'Test category to run (all, memory, llm, network)'
        required: false
        default: 'all'

# Minimal permissions for security
permissions:
  contents: read
  checks: write
  actions: write # enable cache/artifact operations with least privilege

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  chaos-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      checks: write
      actions: write

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6 - pinned for supply chain integrity

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6 - pinned for supply chain integrity
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Restore Python cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4 - pinned for reproducible caching
        with:
          path: |
            ~/.cache/pip
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python-version }}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run chaos tests - Memory Pressure
        if: ${{ github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'memory' || github.event_name == 'schedule' }}
        run: |
          pytest tests/chaos/test_memory_pressure.py -v -m chaos --tb=short --junitxml=chaos-memory-results.xml
        # INFORMATIONAL: Chaos tests are exploratory and validate resilience, not correctness
        # Failures indicate areas for improvement but should not block deployment
        continue-on-error: true

      - name: Run chaos tests - Slow LLM
        if: ${{ github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'llm' || github.event_name == 'schedule' }}
        run: |
          pytest tests/chaos/test_slow_llm.py -v -m chaos --tb=short --junitxml=chaos-llm-results.xml
        # INFORMATIONAL: Chaos tests are exploratory and validate resilience, not correctness
        # Failures indicate areas for improvement but should not block deployment
        continue-on-error: true

      - name: Run chaos tests - Network Timeout
        if: ${{ github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'network' || github.event_name == 'schedule' }}
        run: |
          pytest tests/chaos/test_network_timeout.py -v -m chaos --tb=short --junitxml=chaos-network-results.xml
        # INFORMATIONAL: Chaos tests are exploratory and validate resilience, not correctness
        # Failures indicate areas for improvement but should not block deployment
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6 - pinned for artifact integrity
        if: always()
        with:
          name: chaos-test-results-py${{ matrix.python-version }}
          path: |
            chaos-*.xml
          retention-days: 30

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@e08919a3b1fb83a78393dfb775a9c37f17d8eea6 # v6 - pinned for supply chain integrity
        if: always()
        with:
          report_paths: 'chaos-*.xml'
          check_name: Chaos Test Results (Python ${{ matrix.python-version }})
          fail_on_failure: false  # Don't fail the workflow, chaos tests may have expected failures

  chaos-summary:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: chaos-tests
    if: always()
    permissions:
      contents: read
      actions: read # download artifacts without elevation

    steps:
      - name: Download all results
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7 - pinned for artifact integrity
        with:
          pattern: chaos-test-results-*
          merge-multiple: true

      - name: Generate summary
        run: |
          echo "# Chaos Engineering Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Categories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Memory Pressure**: Tests system behavior under memory constraints" >> $GITHUB_STEP_SUMMARY
          echo "- **Slow LLM**: Tests timeout handling and degradation with slow responses" >> $GITHUB_STEP_SUMMARY
          echo "- **Network Timeout**: Tests graceful handling of network failures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if ls chaos-*.xml 1> /dev/null 2>&1; then
            echo "Test result files generated. See artifacts for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "No test results found." >> $GITHUB_STEP_SUMMARY
          fi
