name: Chaos Engineering Tests

# REL-003: Run chaos tests on schedule (not on every PR)
# These are heavy tests that exercise failure modes and resilience
on:
  schedule:
    # Run daily at 3:00 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      test_category:
        description: 'Test category to run (all, memory, llm, network)'
        required: false
        default: 'all'

# Cancel in-progress runs on same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions for security
permissions:
  contents: read
  checks: write

jobs:
  chaos-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      checks: write
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-chaos-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
          restore-keys: |
            pip-chaos-${{ runner.os }}-${{ matrix.python-version }}-
            pip-chaos-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      # Run chaos tests based on test_category input
      # Supports selective execution for debugging specific failures
      - name: Run chaos tests
        run: |
          CATEGORY="${{ github.event.inputs.test_category || 'all' }}"
          if [ "$CATEGORY" = "all" ]; then
            pytest tests/chaos/ -v -m chaos --tb=short --junitxml=chaos-results.xml
          elif [ "$CATEGORY" = "memory" ]; then
            pytest tests/chaos/test_memory_pressure.py -v -m chaos --tb=short --junitxml=chaos-results.xml
          elif [ "$CATEGORY" = "llm" ]; then
            pytest tests/chaos/test_slow_llm.py -v -m chaos --tb=short --junitxml=chaos-results.xml
          elif [ "$CATEGORY" = "network" ]; then
            pytest tests/chaos/test_network_timeout.py -v -m chaos --tb=short --junitxml=chaos-results.xml
          else
            pytest tests/chaos/ -v -m chaos --tb=short --junitxml=chaos-results.xml
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chaos-test-results-py${{ matrix.python-version }}
          path: |
            chaos-results.xml
          retention-days: 30

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: 'chaos-results.xml'
          check_name: Chaos Test Results (Python ${{ matrix.python-version }})
          fail_on_failure: true  # Chaos tests should pass - they test resilience, not breakage

  chaos-summary:
    runs-on: ubuntu-latest
    needs: chaos-tests
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: chaos-test-results-*
          merge-multiple: true

      - name: Generate summary
        run: |
          echo "# Chaos Engineering Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Categories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Memory Pressure**: Tests system behavior under memory constraints" >> $GITHUB_STEP_SUMMARY
          echo "- **Slow LLM**: Tests timeout handling and degradation with slow responses" >> $GITHUB_STEP_SUMMARY
          echo "- **Network Timeout**: Tests graceful handling of network failures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if ls chaos-results.xml 1> /dev/null 2>&1; then
            echo "Test result files generated. See artifacts for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "No test results found." >> $GITHUB_STEP_SUMMARY
          fi
