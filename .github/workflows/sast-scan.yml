name: SAST Security Scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Cancel in-progress runs on same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  bandit:
    name: Bandit SAST Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[sarif]
      
      - name: Run bandit scan
        run: |
          # Run bandit with SARIF output for GitHub Security
          bandit -r src/mlsdm \
            -f sarif \
            -o bandit-results.sarif \
            --severity-level medium \
            --confidence-level medium \
            || true  # Don't fail yet, check results below
      
      - name: Check for high severity issues
        run: |
          # Run with high severity to display issues
          bandit -r src/mlsdm \
            -f txt \
            --severity-level high \
            --confidence-level high
          
          # This will fail if high severity issues are found
          bandit -r src/mlsdm \
            --severity-level high \
            --confidence-level high \
            -q  # Quiet mode, only returns exit code
      
      - name: Upload SARIF file
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit-results.sarif
          category: bandit
      
      - name: Generate readable report
        if: always()
        run: |
          echo "## Bandit Security Scan Results" > bandit-summary.md
          echo "" >> bandit-summary.md
          bandit -r src/mlsdm -f txt >> bandit-summary.md 2>&1 || true
      
      - name: Upload scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: |
            bandit-summary.md
            bandit-results.sarif
          retention-days: 30

  # ============================================================
  # Semgrep SAST Scan
  # ============================================================
  # 
  # MIGRATION NOTE (December 2025):
  # Previously used semgrep/semgrep-action@v1 which relied on the deprecated
  # returntocorp/semgrep-agent:v1 Docker image. That image is no longer 
  # maintained and causes intermittent Docker Hub 500 errors.
  #
  # This job now uses the official semgrep/semgrep Docker image directly,
  # which is the recommended approach per Semgrep documentation.
  #
  # To run the same scan locally:
  #   docker run --rm -v "${PWD}:/src" semgrep/semgrep:latest \
  #     semgrep scan --config auto --config p/python --config p/security-audit \
  #     --exclude '.venv' --exclude 'dist' --exclude 'build' \
  #     --exclude '.mypy_cache' --exclude '.pytest_cache' \
  #     --sarif --output semgrep-results.sarif
  #
  # To update Semgrep rules:
  #   - Edit the --config flags below
  #   - Available rulesets: https://semgrep.dev/explore
  # ============================================================
  semgrep:
    name: Semgrep SAST Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    container:
      image: semgrep/semgrep:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep scan
        run: |
          semgrep scan \
            --config auto \
            --config p/python \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --exclude '.venv' \
            --exclude 'dist' \
            --exclude 'build' \
            --exclude '.mypy_cache' \
            --exclude '.pytest_cache' \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '*.min.js' \
            --sarif \
            --output semgrep-results.sarif \
            --metrics off \
            --error \
            || echo "Semgrep scan completed with findings"
        env:
          # If SEMGREP_APP_TOKEN is set in repo secrets, use Semgrep Cloud features
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload Semgrep SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep

      - name: Upload Semgrep results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.sarif
          retention-days: 30
