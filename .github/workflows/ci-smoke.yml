name: CI Smoke Tests

on:
  push:
    branches:
      - main
      - 'feature/*'
  pull_request:
    branches:
      - main
      - 'feature/*'

permissions:
  contents: read

jobs:
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: CI setup
        uses: ./.github/actions/ci-setup
        with:
          python-version: '3.11'
          checkout-fetch-depth: '0'
          install-command: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt
            pip install -e ".[test]"

      - name: Guard against hidden/bidirectional Unicode
        run: python scripts/check_bidi.py

      - name: Run smoke tests (fast unit tests only)
        run: |
          mkdir -p artifacts
          # Run all unit tests except slow ones for fast feedback
          # The 'slow' marker is already defined and used in the codebase
          # This gives us fast feedback on basic functionality
          pytest tests/unit/ -v -m "not slow" --tb=short -q --maxfail=5 --junitxml=artifacts/junit-smoke.xml
        timeout-minutes: 3

      - name: Upload smoke junit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: smoke-junit
          path: artifacts/junit-smoke.xml
          retention-days: 7

      - name: Run critical module imports
        run: |
          python -c "
          print('Testing critical imports...')
          from mlsdm.core.cognitive_controller import CognitiveController
          from mlsdm.engine.neuro_cognitive_engine import NeuroCognitiveEngine
          from mlsdm.api.middleware import BulkheadMiddleware, TimeoutMiddleware
          from mlsdm.security.rbac import RBACMiddleware, Role, RoleValidator
          from mlsdm.observability.logger import ObservabilityLogger
          from mlsdm.observability.metrics import MetricsExporter
          print('✓ All critical imports successful')
          "

      - name: Validate configuration files
        run: |
          python -c "
          import yaml
          import os

          config_files = [
              'config/default_config.yaml',
          ]

          for config_file in config_files:
              if os.path.exists(config_file):
                  with open(config_file) as f:
                      yaml.safe_load(f)
                  print(f'✓ {config_file} is valid YAML')
              else:
                  print(f'⚠ {config_file} not found (optional)')
          "

  coverage-gate:
    name: Coverage Gate
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: CI setup
        uses: ./.github/actions/ci-setup
        with:
          python-version: '3.11'
          install-command: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt
            pip install -e ".[test]"

      - name: Run coverage gate
        run: ./coverage_gate.sh
        env:
          COVERAGE_MIN: 75  # Staged target: 65% -> 75% -> 85% -> 90%

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 30

  ablation-smoke:
    name: Ablation Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: CI setup
        uses: ./.github/actions/ci-setup
        with:
          python-version: '3.11'
          install-command: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt
            pip install -e ".[test]"

      - name: Run ablation baseline smoke test
        run: |
          python scripts/eval/run_ablation.py --mode baseline --seed 42
        timeout-minutes: 1

      - name: Run ablation tests
        run: |
          pytest tests/eval/test_ablation_runner.py -v --tb=short -q
        timeout-minutes: 2

      - name: Upload ablation report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ablation-report
          path: reports/ablation/*.json
          retention-days: 30

  policy-check:
    name: Policy Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install conftest
        run: |
          curl -L -o conftest.tar.gz --fail --retry 3 \
            https://github.com/open-policy-agent/conftest/releases/download/v0.55.0/conftest_0.55.0_Linux_x86_64.tar.gz
          tar -xzf conftest.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
          rm conftest.tar.gz

      - name: Run policy checks on CI workflows
        run: |
          echo "Checking CI workflow policies..."
          # Use --fail-on-warn=false to allow warnings but fail on denies
          conftest test .github/workflows/*.yml -p policies/ci/ --all-namespaces --fail-on-warn=false

  failure-intelligence:
    name: Failure Intelligence
    needs:
      - smoke
      - coverage-gate
      - ablation-smoke
      - policy-check
    if: ${{ always() }}
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: CI setup
        uses: ./.github/actions/ci-setup
        with:
          python-version: '3.11'
          install-command: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt

      - name: Determine changed files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            git fetch origin "${{ github.event.pull_request.base.ref }}" --depth=1
          else
            BASE_REF="${{ github.ref_name }}"
          fi
          echo "BASE_REF=$BASE_REF" >> "$GITHUB_ENV"
          git diff --name-only origin/"$BASE_REF"...HEAD > changed_files.txt || true
          if [ ! -s changed_files.txt ]; then
            git diff --name-only HEAD~1...HEAD > changed_files.txt || true
          fi

      - name: Download smoke junit
        uses: actions/download-artifact@v6
        with:
          name: smoke-junit
          path: artifacts
        continue-on-error: true

      - name: Download coverage report
        uses: actions/download-artifact@v6
        with:
          name: coverage-report
          path: artifacts
        continue-on-error: true

      - name: Download ablation report
        uses: actions/download-artifact@v6
        with:
          name: ablation-report
          path: artifacts
        continue-on-error: true

      - name: Generate failure intelligence summary
        if: always()
        run: |
          python scripts/ci/failure_intelligence.py \
            --junit artifacts/junit-smoke.xml \
            --coverage artifacts/coverage.xml \
            --changed-files changed_files.txt \
            --out failure_summary.md \
            --json failure_summary.json

      - name: Publish job summary
        if: always()
        run: |
          if [[ -f failure_summary.md ]]; then
            cat failure_summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Failure Intelligence produced no summary file." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload failure intelligence artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: failure-intelligence
          path: |
            failure_summary.md
            failure_summary.json
            changed_files.txt
          retention-days: 7
