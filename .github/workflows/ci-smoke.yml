name: CI Smoke Tests

on:
  push:
    branches:
      - main
      - 'feature/*'
  pull_request:
    branches:
      - main
      - 'feature/*'

permissions:
  contents: read

jobs:
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Guard against hidden/bidirectional Unicode
        run: python scripts/check_bidi.py

      - name: Guard against generated artifacts
        run: python scripts/ci/no_generated_artifacts.py

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"
          python -m pip check

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run smoke tests (fast unit tests only)
        run: |
          mkdir -p artifacts
          # Run all unit tests except slow ones for fast feedback
          # The 'slow' marker is already defined and used in the codebase
          # This gives us fast feedback on basic functionality
          pytest tests/unit/ -v -m "not slow" --tb=short -q --maxfail=5 --junitxml=artifacts/junit-smoke.xml
        timeout-minutes: 3

      - name: Upload smoke junit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: smoke-junit
          path: artifacts/junit-smoke.xml
          retention-days: 7

      - name: Run critical module imports
        run: |
          python -c "
          print('Testing critical imports...')
          from mlsdm.core.cognitive_controller import CognitiveController
          from mlsdm.engine.neuro_cognitive_engine import NeuroCognitiveEngine
          from mlsdm.api.middleware import BulkheadMiddleware, TimeoutMiddleware
          from mlsdm.security.rbac import RBACMiddleware, Role, RoleValidator
          from mlsdm.observability.logger import ObservabilityLogger
          from mlsdm.observability.metrics import MetricsExporter
          print('✓ All critical imports successful')
          "

      - name: Validate configuration files
        run: |
          python -c "
          import yaml
          import os

          config_files = [
              'config/default_config.yaml',
          ]

          for config_file in config_files:
              if os.path.exists(config_file):
                  with open(config_file) as f:
                      yaml.safe_load(f)
                  print(f'✓ {config_file} is valid YAML')
              else:
                  print(f'⚠ {config_file} not found (optional)')
          "

  coverage-gate:
    name: Coverage Gate
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"
          python -m pip check

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run coverage gate
        run: ./coverage_gate.sh
        env:
          COVERAGE_MIN: 75  # Staged target: 65% -> 75% -> 85% -> 90%

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 30

  ablation-smoke:
    name: Ablation Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"
          python -m pip check

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run ablation baseline smoke test
        run: |
          python scripts/eval/run_ablation.py --mode baseline --seed 42
        timeout-minutes: 1

      - name: Run ablation tests
        run: |
          pytest tests/eval/test_ablation_runner.py -v --tb=short -q
        timeout-minutes: 2

      - name: Upload ablation report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ablation-report
          path: reports/ablation/*.json
          retention-days: 30

  policy-check:
    name: Policy Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install policy dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m pip check

      - name: Install conftest
        run: |
          curl -L -o conftest.tar.gz --fail --retry 3 \
            https://github.com/open-policy-agent/conftest/releases/download/v0.55.0/conftest_0.55.0_Linux_x86_64.tar.gz
          tar -xzf conftest.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
          rm conftest.tar.gz

      - name: Validate policy configuration
        run: python scripts/validate_policy_config.py

      - name: Generate OPA policy data
        run: python scripts/policy/export_policy_data.py --output build/policy_data.json

      - name: Run policy checks on CI workflows
        run: |
          echo "Checking CI workflow policies..."
          # Use --fail-on-warn=false to allow warnings but fail on denies
          conftest test .github/workflows/*.yml -p policies/ci/ -d build/policy_data.json --all-namespaces --fail-on-warn=false

      - name: Verify policy fixtures
        run: python scripts/policy/verify_policy_fixtures.py --data build/policy_data.json

  dependency-drift-check:
    name: Dependency Drift Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Check dependency drift
        run: |
          # Regenerate requirements to surface drift in git diff for easier debugging
          # Policy requires regeneration + diff instead of --check to catch missing extras
          python scripts/ci/export_requirements.py
          git diff requirements.txt || true
          git diff --exit-code requirements.txt

      - name: Validate defusedxml is resolvable
        run: |
          set -e
          pip install defusedxml --dry-run
          echo "✓ defusedxml is resolvable"

  failure-intelligence:
    name: Failure Intelligence
    needs:
      - smoke
      - coverage-gate
      - ablation-smoke
      - policy-check
      - dependency-drift-check
    if: ${{ always() }}
    runs-on: ubuntu-latest
    timeout-minutes: 5

    # Artifact Contract: Expected artifact names and paths
    env:
      FI_JUNIT_ARTIFACT: smoke-junit
      FI_JUNIT_PATH: artifacts/junit-smoke.xml
      FI_COV_ARTIFACT: coverage-report
      FI_COV_PATH: artifacts/coverage.xml
      FI_ABLATION_ARTIFACT: ablation-report
      FI_ABLATION_PATH: artifacts

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Determine changed files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            git fetch origin "${{ github.event.pull_request.base.ref }}" --depth=1
          else
            BASE_REF="${{ github.ref_name }}"
          fi
          echo "BASE_REF=$BASE_REF" >> "$GITHUB_ENV"
          git diff --name-only origin/"$BASE_REF"...HEAD > changed_files.txt || true
          if [ ! -s changed_files.txt ]; then
            git diff --name-only HEAD~1...HEAD > changed_files.txt || true
          fi

      - name: Download smoke junit
        uses: actions/download-artifact@v7
        with:
          name: ${{ env.FI_JUNIT_ARTIFACT }}
          path: artifacts
        continue-on-error: true

      - name: Download coverage report
        uses: actions/download-artifact@v7
        with:
          name: ${{ env.FI_COV_ARTIFACT }}
          path: artifacts
        continue-on-error: true

      - name: Download ablation report
        uses: actions/download-artifact@v7
        with:
          name: ${{ env.FI_ABLATION_ARTIFACT }}
          path: artifacts
        continue-on-error: true

      - name: Validate artifact presence
        if: always()
        run: |
          echo "=== Artifact Contract Validation ==="
          MISSING_ARTIFACTS=""

          if [ ! -f "$FI_JUNIT_PATH" ]; then
            echo "⚠ Missing: $FI_JUNIT_ARTIFACT ($FI_JUNIT_PATH)"
            MISSING_ARTIFACTS="${MISSING_ARTIFACTS}junit,"
          else
            echo "✓ Present: $FI_JUNIT_ARTIFACT"
          fi

          if [ ! -f "$FI_COV_PATH" ]; then
            echo "⚠ Missing: $FI_COV_ARTIFACT ($FI_COV_PATH)"
            MISSING_ARTIFACTS="${MISSING_ARTIFACTS}coverage,"
          else
            echo "✓ Present: $FI_COV_ARTIFACT"
          fi

          echo "MISSING_ARTIFACTS=${MISSING_ARTIFACTS}" >> "$GITHUB_ENV"

          # Report status but don't fail - the script handles missing inputs gracefully
          if [ -n "$MISSING_ARTIFACTS" ]; then
            echo ""
            echo "Note: Some artifacts are missing. Failure Intelligence will report degraded status."
          fi

      - name: Generate failure intelligence summary
        if: always()
        run: |
          python scripts/ci/failure_intelligence.py \
            --junit "$FI_JUNIT_PATH" \
            --coverage "$FI_COV_PATH" \
            --changed-files changed_files.txt \
            --out failure_summary.md \
            --json failure_summary.json

      - name: Publish job summary
        if: always()
        run: |
          if [[ -f failure_summary.md ]]; then
            cat failure_summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Failure Intelligence produced no summary file." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload failure intelligence artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: failure-intelligence
          path: |
            failure_summary.md
            failure_summary.json
            changed_files.txt
          retention-days: 7
