name: Readiness Gate

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: write
  pull-requests: write

jobs:
  readiness:
    if: >
      github.actor != 'github-actions[bot]' &&
      !contains(github.event.head_commit.message || '', '[skip readiness]') &&
      !contains(github.event.pull_request.title || '', '[skip readiness]')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e ".[dev]"
      - name: Detect readiness auto-apply label
        id: apply
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request?.labels?.map(l => l.name) || [];
            const apply = labels.includes('readiness-auto-apply');
            core.setOutput('apply', apply ? 'true' : 'false');
            const sameRepo = (context.payload.pull_request?.head?.repo?.full_name === context.repo.owner + '/' + context.repo.repo);
            core.setOutput('same_repo', sameRepo ? 'true' : 'false');
      - name: Compute changed files
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref || 'main' }}
        run: |
          set -eo pipefail
          git fetch origin "${BASE_REF}"
          git diff --name-only "origin/${BASE_REF}...HEAD" | sed '/^$/d' > /tmp/paths.txt
          if [ ! -s /tmp/paths.txt ]; then
            echo "No changed files detected; writing empty list"
          fi
      - name: Run change analysis
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref || 'main' }}
        run: |
          python scripts/readiness/change_analyzer.py --files /tmp/paths.txt --base-ref "origin/${BASE_REF}" --output /tmp/change.json
      - name: Collect evidence
        run: python scripts/readiness/evidence_collector.py --output /tmp/evidence.json
      - name: Evaluate policy
        run: python scripts/readiness/policy_engine.py --change-analysis /tmp/change.json --evidence /tmp/evidence.json --output /tmp/policy.json
      - name: Update readiness log
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref || 'main' }}
          TITLE: ${{ github.event.pull_request.title || github.event.head_commit.message || 'Automated readiness update' }}
          APPLY: ${{ steps.apply.outputs.apply || (github.event_name != 'pull_request') }}
          SAME_REPO: ${{ steps.apply.outputs.same_repo || 'false' }}
        run: |
          MODE="preview"
          if [ "${APPLY}" = "true" ] && [ "${SAME_REPO}" = "true" ]; then
            MODE="apply"
          fi
          python scripts/readiness/changelog_generator.py --title "${TITLE}" --base-ref "origin/${BASE_REF}" --mode "${MODE}"
      - name: Commit readiness update
        if: ${{ github.event_name == 'pull_request' && steps.apply.outputs.apply == 'true' && steps.apply.outputs.same_repo == 'true' }}
        env:
          BRANCH: ${{ github.head_ref || github.ref_name }}
        run: |
          if git diff --quiet; then
            echo "No readiness changes to commit"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/status/READINESS.md
          git commit -m "chore: update readiness log [skip ci]"
          git push origin "HEAD:${BRANCH}"
      - name: Post readiness summary
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const change = JSON.parse(fs.readFileSync('/tmp/change.json', 'utf8'));
            const evidence = JSON.parse(fs.readFileSync('/tmp/evidence.json', 'utf8'));
            const policy = JSON.parse(fs.readFileSync('/tmp/policy.json', 'utf8'));
            const body = [
              `Readiness summary (automated):`,
              `- Verdict: **${policy.verdict || 'unknown'}**`,
              `- Max risk: ${policy.max_risk || 'unknown'}`,
              `- Evidence: ${evidence.evidence_hash || 'n/a'}`,
              `- Policy hash: ${policy.policy_hash || 'n/a'}`,
              `- Changed files: ${(change.files || []).length}`,
            ].join('\n');
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            });
