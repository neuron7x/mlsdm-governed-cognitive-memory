name: Load Tests

on:
  schedule:
    # Run weekly on Sunday at 4:00 AM UTC
    - cron: '0 4 * * 0'
  workflow_dispatch:
    inputs:
      users:
        description: 'Number of concurrent users'
        required: false
        default: '20'
      duration:
        description: 'Test duration in seconds'
        required: false
        default: '30'

permissions:
  contents: read
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  load-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: CI setup
        uses: ./.github/actions/ci-setup
        with:
          python-version: '3.11'
          cache-paths: |
            ~/.cache/pip
            ~/.cache/uv
            .venv
          install-command: |
            python -m pip install --upgrade pip
            pip install -e ".[dev]"

      - name: Run standalone load test
        env:
          LOAD_USERS: ${{ inputs.users }}
          LOAD_DURATION: ${{ inputs.duration }}
        run: |
          set -euo pipefail
          : "${LOAD_USERS:=20}" "${LOAD_DURATION:=30}"

          validate_positive_int() {
            local value="$1"
            local label="$2"

            if ! [[ "$value" =~ ^[0-9]+$ ]] || [ "$value" -le 0 ]; then
              echo "Invalid $label value: $value" >&2
              exit 1
            fi
          }

          validate_positive_int "$LOAD_USERS" "users"
          validate_positive_int "$LOAD_DURATION" "duration"
          echo "Running load test with users=$LOAD_USERS duration=$LOAD_DURATION"
          python tests/load/standalone_server_load_test.py \
            --users "$LOAD_USERS" \
            --duration "$LOAD_DURATION" \
            --output load-test-report.json

      - name: Summarize load test report
        if: always()
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          report_path = Path("load-test-report.json")
          summary_path = Path("summary.md")

          if not report_path.exists():
              summary_path.write_text("## Load Test Summary\n\nNo report file generated.\n")
              raise SystemExit(0)

          data = json.loads(report_path.read_text())
          request = data.get("request_metrics", {})
          latency = data.get("latency_metrics_ms", {})
          memory = data.get("memory_metrics_mb", {})
          status = data.get("status", {})

          summary = [
              "## Load Test Summary",
              "",
              f"- Success rate: {request.get('success_rate_percent', 'n/a')}%",
              f"- RPS: {request.get('requests_per_second', 'n/a')}",
              f"- P95 latency (ms): {latency.get('p95', 'n/a')}",
              f"- Memory growth (MB): {memory.get('growth', 'n/a')}",
              f"- Status: {'PASSED' if status.get('passed') else 'FAILED'}",
          ]
          summary_path.write_text("\n".join(summary) + "\n")
          print(summary_path.read_text())
          PY

      - name: Upload load test artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: load-test-results-${{ github.run_number }}
          path: |
            load-test-report.json
            summary.md
          retention-days: 90

      - name: Publish load test summary
        if: always()
        run: |
          if [ -f summary.md ]; then
            cat summary.md >> "$GITHUB_STEP_SUMMARY"
          fi
