name: Dependency Scanning

on:
  schedule:
    # Run daily at 1 AM UTC
    - cron: '0 1 * * *'
  pull_request:
    paths:
      - 'requirements.txt'
      - 'pyproject.toml'
  workflow_dispatch:

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, Python-2.0

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
          
      - name: Run pip-audit
        run: |
          pip-audit --desc --require requirements.txt --format json --output audit-report.json
        continue-on-error: true
        
      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-report
          path: audit-report.json
          retention-days: 30

  safety-check:
    name: Safety Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install Safety
        run: |
          python -m pip install --upgrade pip
          pip install safety
          
      - name: Run Safety check
        run: |
          safety check --json --output safety-report.json --file requirements.txt
        continue-on-error: true
        
      - name: Upload safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-report
          path: safety-report.json
          retention-days: 30

  license-check:
    name: License Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-licenses
          pip install -r requirements.txt
          
      - name: Check licenses
        run: |
          pip-licenses --format=json --output-file=licenses.json
          pip-licenses --format=markdown --output-file=licenses.md
          
      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            licenses.json
            licenses.md
          retention-days: 30

  vulnerability-scan:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml]
          
      - name: Run Bandit
        run: |
          bandit -r src/ -f sarif -o bandit.sarif
        continue-on-error: true
        
      - name: Upload Bandit SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: bandit.sarif
        continue-on-error: true

  outdated-dependencies:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Check for outdated packages
        run: |
          pip list --outdated --format=json > outdated-packages.json
          pip list --outdated
          
      - name: Upload outdated packages report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: outdated-packages
          path: outdated-packages.json
          retention-days: 30

  dependency-graph:
    name: Generate Dependency Graph
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install pipdeptree
        run: |
          python -m pip install --upgrade pip
          pip install pipdeptree
          pip install -r requirements.txt
          
      - name: Generate dependency tree
        run: |
          pipdeptree --json > dependency-tree.json
          pipdeptree > dependency-tree.txt
          
      - name: Upload dependency tree
        uses: actions/upload-artifact@v4
        with:
          name: dependency-tree
          path: |
            dependency-tree.json
            dependency-tree.txt
          retention-days: 30

  summary:
    name: Dependency Scan Summary
    runs-on: ubuntu-latest
    needs: [security-audit, safety-check, license-check, vulnerability-scan, outdated-dependencies]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "# Dependency Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Safety Check: ${{ needs.safety-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- License Check: ${{ needs.license-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerability Scan: ${{ needs.vulnerability-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Outdated Dependencies: ${{ needs.outdated-dependencies.result }}" >> $GITHUB_STEP_SUMMARY
