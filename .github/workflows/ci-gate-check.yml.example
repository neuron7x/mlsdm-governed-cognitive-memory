name: CI Gate Check
# Optional workflow demonstrating CI Performance & Resilience Gate integration
# Rename to ci-gate-check.yml to enable

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read
  pull-requests: write  # For posting comments
  actions: write # needed for cached setup while limiting scope

jobs:
  ci-gate-analysis:
    name: CI Performance & Resilience Gate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6 - pinned for supply chain integrity

      - name: Set up Python 3.11
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6 - pinned for supply chain integrity
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        run: pip install requests

      - name: Run CI Gate Analysis
        id: gate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/ci_perf_resilience_gate.py \
            --pr-number ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --output markdown > gate-report.md

          # Capture exit code
          EXIT_CODE=$?
          echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT

          # Show report in workflow log
          echo "=== CI Gate Report ==="
          cat gate-report.md

          # Exit with gate's exit code (0=safe, 1=not ready, 2=risk)
          exit ${EXIT_CODE}

      - name: Upload Gate Report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6 - pinned for artifact integrity
        with:
          name: ci-gate-report
          path: gate-report.md
          retention-days: 30

      - name: Post Report as Comment (Optional)
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7 - pinned for supply chain integrity
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('gate-report.md', 'utf8');
            const exitCode = '${{ steps.gate.outputs.exit_code }}';

            const verdict =
              exitCode === '0' ? '✅ SAFE TO MERGE' :
              exitCode === '1' ? '❌ DO NOT MERGE YET' :
              '⚠️ MERGE WITH CAUTION';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ${verdict}\n\n${report}`
            });
