name: CI

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

permissions:
  contents: read
  security-events: write

env:
  PYTHON_VERSION: '3.11'
  PIP_CACHE_DIR: ~/.cache/pip

jobs:
  # ============================================
  # Code Quality Gate
  # ============================================
  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run ruff linter
        run: ruff check src tests

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"

      - name: Run mypy type checker
        run: mypy src/mlsdm

  # ============================================
  # Security Gate
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit bandit
          pip install -r requirements.txt

      - name: Run pip-audit for dependency vulnerabilities
        run: pip-audit --strict --progress-spinner=off
        continue-on-error: true

      - name: Run bandit security linter
        run: bandit -r src -ll -ii -x "*/tests/*"
        continue-on-error: true

  # ============================================
  # Test Gate
  # ============================================
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Run unit tests
        run: pytest tests/unit -q --tb=short

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Run integration tests
        run: pytest tests/integration -v --tb=short

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Run E2E tests
        run: pytest tests/e2e -v -m "not slow" --tb=short
        env:
          LLM_BACKEND: local_stub
          DISABLE_RATE_LIMIT: "1"

  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Run property-based tests
        run: pytest tests/property -v --tb=short --maxfail=5

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Run security tests
        run: pytest tests/security -v --tb=short

  # ============================================
  # Coverage Gate
  # ============================================
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Run tests with coverage
        run: |
          pytest --ignore=tests/load \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=90 \
            -q

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 30

  # ============================================
  # Validation Gate
  # ============================================
  effectiveness-validation:
    name: Effectiveness Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Run effectiveness suite with SLO validation
        run: python scripts/run_effectiveness_suite.py --validate-slo

      - name: Upload effectiveness snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: effectiveness-snapshot
          path: |
            reports/effectiveness_snapshot.json
            reports/EFFECTIVENESS_SNAPSHOT.md
          retention-days: 90

  # ============================================
  # CI Summary Gate
  # ============================================
  ci-passed:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs:
      - lint
      - type-check
      - security-scan
      - unit-tests
      - integration-tests
      - e2e-tests
      - property-tests
      - security-tests
      - coverage
      - effectiveness-validation
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.type-check.result }}" != "success" ]] || \
             [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}" != "success" ]] || \
             [[ "${{ needs.e2e-tests.result }}" != "success" ]] || \
             [[ "${{ needs.property-tests.result }}" != "success" ]] || \
             [[ "${{ needs.security-tests.result }}" != "success" ]] || \
             [[ "${{ needs.coverage.result }}" != "success" ]] || \
             [[ "${{ needs.effectiveness-validation.result }}" != "success" ]]; then
            echo "One or more CI checks failed"
            echo "lint: ${{ needs.lint.result }}"
            echo "type-check: ${{ needs.type-check.result }}"
            echo "unit-tests: ${{ needs.unit-tests.result }}"
            echo "integration-tests: ${{ needs.integration-tests.result }}"
            echo "e2e-tests: ${{ needs.e2e-tests.result }}"
            echo "property-tests: ${{ needs.property-tests.result }}"
            echo "security-tests: ${{ needs.security-tests.result }}"
            echo "coverage: ${{ needs.coverage.result }}"
            echo "effectiveness-validation: ${{ needs.effectiveness-validation.result }}"
            echo "Note: security-scan is advisory and not blocking: ${{ needs.security-scan.result }}"
            exit 1
          fi
          echo "All CI checks passed successfully!"
