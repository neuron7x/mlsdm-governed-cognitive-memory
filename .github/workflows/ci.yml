name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-asyncio
          
      - name: Run all tests with coverage
        run: |
          pytest src/tests/ tests/ -v \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=90
            
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: full-suite
          name: ci-tests
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  chaos-engineering-smoke:
    name: Chaos Engineering (Smoke)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-asyncio
          
      - name: Run chaos smoke tests
        run: |
          # Run tests that simulate failures
          pytest src/tests/unit/ -v -k "concurrent or thread" --tb=short

  performance-baseline:
    name: Performance Baseline
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-asyncio pytest-benchmark
          
      - name: Run performance validation tests
        run: |
          python tests/validation/test_wake_sleep_effectiveness.py
          python tests/validation/test_moral_filter_effectiveness.py
          
      - name: Store performance metrics
        uses: actions/upload-artifact@v4
        with:
          name: performance-metrics
          path: |
            *.png
            *.json
          retention-days: 30

  memory-leak-detection:
    name: Memory Leak Detection
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-asyncio memory-profiler
          
      - name: Run extended memory tests
        run: |
          # Run tests that check for memory leaks
          pytest src/tests/unit/test_cognitive_controller.py -v --tb=short
          pytest src/tests/unit/test_memory_manager.py -v --tb=short

  build-validation:
    name: Build & Package Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
          
      - name: Build package
        run: |
          python -m build
        continue-on-error: true
        
      - name: Check package
        run: |
          twine check dist/* || echo "Package check skipped - no dist files"
        continue-on-error: true

  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check for Dockerfile
        id: check_dockerfile
        run: |
          if [ -f "Dockerfile" ] || [ -f "docker/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Set up Docker Buildx
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3
        
      - name: Build Docker image
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          if [ -f "Dockerfile" ]; then
            docker build -t mlsdm-cognitive-memory:test .
          elif [ -f "docker/Dockerfile" ]; then
            docker build -f docker/Dockerfile -t mlsdm-cognitive-memory:test .
          fi

  integration-health-check:
    name: Integration Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-asyncio
          
      - name: Run integration tests
        run: |
          python tests/integration/test_end_to_end.py
          
      - name: Test API startup
        run: |
          # Start API in background
          timeout 10s python -m src.main --api &
          sleep 5
          # Check if process is running
          pgrep -f "src.main" || echo "API not started (expected if no --api support)"
        continue-on-error: true

  notification:
    name: Build Status Notification
    runs-on: ubuntu-latest
    needs: [full-test-suite, performance-baseline, build-validation]
    if: always() && github.event_name == 'push'
    
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.full-test-suite.result }}" == "success" ]] && \
             [[ "${{ needs.performance-baseline.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=✅" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=❌" >> $GITHUB_OUTPUT
          fi
          
      - name: Summary
        run: |
          echo "${{ steps.status.outputs.emoji }} CI Build ${{ steps.status.outputs.status }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
